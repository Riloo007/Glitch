<html>
<head>
  <title>Terrain Generator</title>
  <link rel="stylesheet" href="style.css">
  <link rel="icon" type="image/x-icon" href="logo.png">
</head>

<div id="global-page-header"></div>


<body>
  <div class="box">
    <div class="box-header">
      <h2>
        Terrain Generator
      </h2>
    </div>

    <!--<img src="logo.png" style="display: block; width: 200px; height: auto;" id="imageDisplay">-->

    <div class="post">
      <div class="postHead">
        <table>
          <tr>
          <tr>Width: <input type="number" id="width" value="80" onchange="QGenerate();"></td><br>
          <tr>Height: <input type="number" id="height" value="30" onchange="QGenerate();"></td><br>
          <tr>X-Scale: <input type="number" id="scale" value="5" onchange="QGenerate();"></td><br>
          <tr>Y-Scale: <input type="number" id="yscale" value="3" onchange="QGenerate();"></td><br>
          <tr><td><button onclick="QGenerate();">Generate</button></td><td><button onclick="saveImage();">Download Image</button></td></tr>
        </table>
      </div>
      <div style="text-align: center;" id="imgTableCont">
        <table id="imgTable" style="table-layout: fixed;"></table>
      </div>
      
      <style>
        #imgTable tbody tr td {background-color: rgb(83, 125, 189);}
        #imgTable {border-spacing: 0px;}
      </style>
    </div>
    
  </div>
</body>

<canvas id="canvas" style="display: none;"></canvas>

<div id="global-page-footer"></div>

<script>
/*    document.getElementById("Img2TxtUpload").onchange = function(evt) {
  var tgt = evt.target || window.event.srcElement,
      files = tgt.files;

  if(FileReader && files && files.length) {
    var fr = new FileReader();
    fr.onload = function () {
      document.getElementById("imageDisplay").src = fr.result;


    }
    fr.readAsDataURL(files[0]);

    //document.getElementById("imageDisplay").style = "display: block;";
  }
};*/

//var canvas = document.getElementById("MainCanvas");
//var ctx = canvas.getContext("2d");

//canvas.style.width = '300px'

function saveImage() {
  width = document.getElementById('width').value;
  height = document.getElementById('height').value;
  img = new Image(width, height);
  let canvas = document.getElementById('canvas');
  canvas.width = width;
  canvas.height = height;
  var ctx = canvas.getContext("2d");

  var imgDat = ctx.getImageData(0,0,width,height);
  var rgb = [0,0,0];

  for(let x = 1; x < width-1; x++) {
    for(let y = 1; y < height-1; y++) {
      rgb = getPixel(x, y);
      console.log(getPixel(x, y)[0], getPixel(x, y)[1], getPixel(x, y)[2]);
      let pix = (x + y*width) * 4;
      //imgDat.push(getPixel(x, y)[1], getPixel(x, y)[1], getPixel(x, y)[2], 255);
      imgDat.data[pix] = getPixel(x, y)[0];
      imgDat.data[pix + 1] = getPixel(x, y)[1];
      imgDat.data[pix + 2] = getPixel(x, y)[2];
      imgDat.data[pix + 3] = getPixel(x, y)[3];
    }
  }
  console.log(imgDat);

  ctx.putImageData(imgDat, 0, 0);

// Convert the canvas to data
var image = canvas.toDataURL();
// Create a link
var aDownloadLink = document.createElement('a');
// Add the name of the file to the link
aDownloadLink.download = 'generated_terrain.png';
// Attach the data to the link
aDownloadLink.href = image;
// Get the code to click the download link
aDownloadLink.click();
}


function QGenerate(){
  Generate(Math.round(document.getElementById('width').value), Math.round(document.getElementById('height').value), document.getElementById('scale').value, document.getElementById('yscale').value);
}
function Generate(width, height, scale, yscale){
  //padd = 3
  //document.getElementById("imgTable").querySelectorAll('td').forEach(resize);

  //changeCSSStyle('#imgTable tbody tr td', 'padding', '1');
  createGrid(width, height);
  padd = document.getElementById("imgTableCont").getBoundingClientRect().width/width;
  for(let x = 0; x < width; x++) {
    for(let y = 0; y < height; y++) {
      document.getElementById("imgTable").rows[y].cells[x].style.padding = "" + padd /2 + "px";
      document.getElementById("imgTable").rows[y].cells[x].style.backgroundColor = "rgba(255,255,255,0)";
    }
  }
  

    //ctx.clearRect(0, 0, canvas.width, canvas.height);
    

    //Generate terrain Shape
    var h = 0;
    var hc = 0;
    for(let x = 1; x < width; x++) {
      h += Math.random() * 0.07 * scale;
      hc += Math.random() * 0.1 * scale;
      y = Math.sin(h) + Math.sin(hc);
      y = (1 / yscale) * (y/3 * (height/3)) + (height/2)

      yi = Math.round(y);

      for(y = yi; y - 1 < height; y++) {
        setPixel(x, y, 0, 0, 0);
      }
      gheight = Math.round(Math.random() * 3)
      for(y = yi; y < gheight + 1 + yi; y++) {
        setPixel(x, y, 35, 120 + Math.random() * 20, 30);
      }
      setPixel(x, gheight + yi + 1, 100, 70, 50);
      setPixel(x, gheight + yi + 2, 100, 70, 50);
      setPixel(x, gheight + yi + 3, 70, 40, 30);
      setPixel(x, gheight + yi + 4, 70, 40, 30);
      setPixel(x, gheight + yi + 5, 40, 25, 20);
      setPixel(x, gheight + yi + 6, 40, 25, 20);
      setPixel(x, gheight + yi + 7, 15, 8, 6);
      setPixel(x, gheight + yi + 8, 15, 8, 6);

    }

    return

    //Colorize

    var yi = 0
    
    //var img = document.getElementById('imageDisplay');
    //ctx.clearRect(0, 0, canvas.width, canvas.height);
    //ctx.drawImage(img, 0, 0, img.width, img.height);
    ctx.getContextAttributes().willReadFrequently = true;

    for(var x = 1; x < canvas.width; x++) {
        for(var y = 1; y < canvas.height; y++) {
          
          if(img.getPixel(x, y) == new THREE.Vector3(0,0,0)) {
            var color = new THREE.Vector3(10, 200, 40);
            img.setPixel(x, y, color)
            //rh = Math.round(Math.random() * 10); drawLine(rh, 30, 30, 30, x, y);
          }
        }
    }

}

function createGrid(x, y) {
  tbl = document.getElementById('imgTable');
  tbl.innerHTML = '';

  for (let i = 0; i < y; i++) {
    const tr = tbl.insertRow();
    for (let j = 0; j < x; j++) {
        tr.insertCell();
    }
  }
}

function getPixel(x, y) {
  x--;y--;o=5;c=[0,0,0,0];
  cell = document.getElementById("imgTable").rows[y].cells[x].style.backgroundColor;

  for(j = 0; j < 4; j++) {
    var i = 0;
    var subs = "";
    while(subs != "," && subs != ")" && cell != "") {
      i++
      subs = cell.substr(o + i, 1);
    }
    if(cell == '' || cell == 'NaN') {r=0; g=0; b=0;}

    //console.log(cell.substr(o, i));
    c[j] = parseInt(cell.substr(o, i))
    o += i + 1;
  }

  if(c[0] == NaN) {c[0] = 0;}
  if(c[1] == NaN) {c[1] = 0;}
  if(c[2] == NaN) {c[2] = 0;}
  if(c[3] == NaN) {c[3] = 0;}

  return c;
}

function setPixel(x, y, r, g, b) {
  x--;y--;
  if(x+1 > Math.round(document.getElementById('width').value) || y+1 > Math.round(document.getElementById('height').value) || x < 0 || y < 0){}else{
    document.getElementById("imgTable").rows[y].cells[x].style.backgroundColor = "rgb(" + r + "," + g + "," + b + ")";
  }
}

</script>


<script src="page.js"></script>
</html>
