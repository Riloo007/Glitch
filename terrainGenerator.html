<html>
<head>
  <title>Terrain Generator</title>
  <link rel="stylesheet" href="style.css">
  <link rel="icon" type="image/x-icon" href="logo.png">
</head>

<div id="global-page-header"></div>


<body>
  <div class="box">
    <div class="box-header">
      <h2>
        Terrain Generator
      </h2>
    </div>

    <!--<img src="logo.png" style="display: block; width: 200px; height: auto;" id="imageDisplay">-->

    <div class="post">
      <div class="postHead">
        <table>
          <tr>
          <tr>Width: <input type="number" id="width" value="80" onchange="QGenerate();"></td><br>
          <tr>Height: <input type="number" id="height" value="30" onchange="QGenerate();"></td><br>
          <tr>X-Scale: <input type="number" id="scale" value="5" onchange="QGenerate();"></td><br>
          <tr>Y-Scale: <input type="number" id="yscale" value="3" onchange="QGenerate();"></td><br>
          <tr>Layer stop: <input type="number" id="layerStop" value="4" onchange="QGenerate();"></td><br>
          <tr><td><button onclick="QGenerate();">Generate</button></td><td><button onclick="saveImage();">Download Image</button></td></tr>
        </table>
      </div>
      <div style="text-align: center;" id="imgTableCont">
        <table id="imgTable" style="table-layout: fixed;"></table>
      </div>

      <!-- <div class="UIlist" id="UIlist">
        <div>
          <table>
            <td><input type="color" value='#57AB44'></td>
            <td><input type="value" value="2"></td>
          
          <td>
            <select onchange='toggleFixedRandom(this);'>
              <option value="1">Fixed</option>
              <option value="2">Random</option>
            </select>
          </td>
  
          <td>
            <button class="UIlistBtn" onclick="removeItem(this);">-</button>
          </td>
          
          
          </table>
        </div>
        <div>
          <table><td><button class="UIlistBtn" onclick="addItem();">+</button></td></table>
        </div>
      </div> -->

      <div class="UIlist" id="UIlist">
        <div>
          <table>
            <tbody><tr><td><input type="color" value="#57AB44"></td>
            <td><input type="value" value="1"></td>
          
          <td><input type="value" value="4"></td><td>
            <select onchange="toggleFixedRandom(this);">
              <option value="2">Random</option>
              <option value="1">Fixed</option>
            </select>
          </td>
  
          <td>
            <button class="UIlistBtn" onclick="removeItem(this);">-</button>
          </td>
          
          
          </tr></tbody></table>
        </div>
        
      <div>
        <table>
          <tbody><tr><td><input type="color" value="#3E8948"></td>
          <td><input type="value" value="2"></td>
        
        <td>
          <select onchange="toggleFixedRandom(this);">
            <option value="1">Fixed</option>
            <option value="2">Random</option>
          </select>
        </td>

        <td>
          <button class="UIlistBtn" onclick="removeItem(this);">-</button>
        </td>
        
        
        </tr></tbody></table>
      </div>
      <div>
        <table>
          <tbody><tr><td><input type="color" value='#34733C'></td>
          <td><input type="value" value="2"></td>
        
        <td>
          <select onchange="toggleFixedRandom(this);">
            <option value="1">Fixed</option>
            <option value="2">Random</option>
          </select>
        </td>

        <td>
          <button class="UIlistBtn" onclick="removeItem(this);">-</button>
        </td>
        
        
        </tr></tbody></table>
      </div>
      <div>
        <table>
          <tbody><tr><td><input type="color" value='#343434'></td>
          <td><input type="value" value="1"></td>
        
        <td>
          <select onchange="toggleFixedRandom(this);">
            <option value="1">Fixed</option>
            <option value="2">Random</option>
          </select>
        </td>

        <td>
          <button class="UIlistBtn" onclick="removeItem(this);">-</button>
        </td>
        
        
        </tr></tbody></table>
      </div>
      <div>
        <table>
          <tbody><tr><td><input type="color" value='#914F49'></td>
          <td><input type="value" value="4"></td><td>
            <select onchange="toggleFixedRandom(this);">
              <option value="1">Fixed</option>
              <option value="2">Random</option>
            </select>
          </td>

        <td>
          <button class="UIlistBtn" onclick="removeItem(this);">-</button>
        </td>
        
        
        </tr></tbody></table>
      </div>
      <div>
        <table>
          <tbody><tr><td><input type="color" value='#733E39'></td>
          <td><input type="value" value="2"></td>
        
        <td>
          <select onchange="toggleFixedRandom(this);">
            <option value="1">Fixed</option>
            <option value="2">Random</option>
          </select>
        </td>

        <td>
          <button class="UIlistBtn" onclick="removeItem(this);">-</button>
        </td>
        
        
        </tr></tbody></table>
      </div>
      <div>
        <table>
          <tbody><tr><td><input type="color" value='#523340'></td>
          <td><input type="value" value="2"></td>
        
        <td>
          <select onchange="toggleFixedRandom(this);">
            <option value="1">Fixed</option>
            <option value="2">Random</option>
          </select>
        </td>

        <td>
          <button class="UIlistBtn" onclick="removeItem(this);">-</button>
        </td>
        
        
        </tr></tbody></table>
      </div><div>
          <table><tbody><tr><td><button class="UIlistBtn" onclick="addItem();">+</button></td></tr></tbody></table>
        </div>
      </div>


      
      <style>
        #imgTable tbody tr td {background-color: rgb(83, 125, 189);}
        #imgTable {border-spacing: 0px;}
      </style>
    </div>
    
  </div>
</body>

<canvas id="canvas" style="display: none;"></canvas>

<div id="global-page-footer"></div>

<script>
  const list = document.getElementById("UIlist");
  function addItem(){
    len = list.children.length;
    list.children[len-1].insertAdjacentHTML("beforebegin", `
      <div>
        <table>
          <td><input type="color"></td>
          <td><input type="value" value="2"></td>
        
        <td>
          <select onchange='toggleFixedRandom(this);'>
            <option value="1">Fixed</option>
            <option value="2">Random</option>
          </select>
        </td>

        <td>
          <button class="UIlistBtn" onclick="removeItem(this);">-</button>
        </td>
        
        
        </table>
      </div>`);
  }

  function toggleFixedRandom(dat) {
    if(dat.value == 2) {console.log("Random"); ExtraInput = "<td><input type=\'value\' value=\'2\'></td>"; dat.parentElement.insertAdjacentHTML("beforebegin", ExtraInput)}
    else {console.log("Fixed"); dat.parentElement.parentElement.getElementsByTagName('input')[1].parentElement.remove();}
  }

  function removeItem(ref) {
  console.log(ref.parentElement.parentElement.parentElement.parentElement.parentElement.innerHTML);
  ref.parentElement.parentElement.parentElement.parentElement.parentElement.remove();
}

function saveImage() {
  width = document.getElementById('width').value;
  height = document.getElementById('height').value;
  img = new Image(width, height);
  let canvas = document.getElementById('canvas');
  canvas.width = width;
  canvas.height = height;
  var ctx = canvas.getContext("2d");

  var imgDat = ctx.getImageData(0,0,width,height);

  for(let x = 0; x < width; x++) {
    for(let y = 0; y < height; y++) {
      let pix = (x + y*width) * 4;
      imgDat.data[pix] = getPixel(x, y)[0];
      imgDat.data[pix + 1] = getPixel(x, y)[1];
      imgDat.data[pix + 2] = getPixel(x, y)[2];
      imgDat.data[pix + 3] = getPixel(x, y)[3];
    }
  }
  console.log(imgDat);

  ctx.putImageData(imgDat, 0, 0);

// Convert the canvas to data
var image = canvas.toDataURL();
// Create a link
var aDownloadLink = document.createElement('a');
// Add the name of the file to the link
aDownloadLink.download = 'generated_terrain.png';
// Attach the data to the link
aDownloadLink.href = image;
// Get the code to click the download link
aDownloadLink.click();
}


function QGenerate(){
  Generate(Math.round(document.getElementById('width').value), Math.round(document.getElementById('height').value), document.getElementById('scale').value, document.getElementById('yscale').value);
}
function Generate(width, height, scale, yscale){
  width++;height++;
  createGrid(width, height);
  padd = document.getElementById("imgTableCont").getBoundingClientRect().width/(width-1)/2;
  for(let x = 0; x < width; x++) {
    for(let y = 0; y < height; y++) {
      document.getElementById("imgTable").rows[y].cells[x].style.padding = "" + padd + "px";
      document.getElementById("imgTable").rows[y].cells[x].style.backgroundColor = "rgba(0,0,0,0)";
    }
  }

    //Generate terrain Shape
    var h = 0;
    var hc = 0;
    for(let x = 1; x < width; x++) {
      h += Math.random() * 0.07 * scale;
      hc += Math.random() * 0.1 * scale;
      y = Math.sin(h) + Math.sin(hc);
      y = (1 / yscale) * (y/3 * (height/3)) + (height/2)

      yi = Math.round(y);

      //Fill terrain shape
      for(y = yi; y - 1 < height; y++) {
        setPixel(x, y, 0, 0, 0, 255);
      }

      //Draw each layer in UI List
      const listDivs = list.getElementsByTagName('div');
      var drHeight = 0;
      for(li = 0; li < listDivs.length - 1; li++) {
        inVal = listDivs[li].getElementsByTagName('input');
        const r = parseInt(inVal[0].value.substr(1,2), 16)
        const g = parseInt(inVal[0].value.substr(3,2), 16)
        const b = parseInt(inVal[0].value.substr(5,2), 16)

        if(inVal.length == 2) {
          for(y = 0; y < inVal[1].value; y++) {
            if(li <= document.getElementById('layerStop').value) {
                setPixel(x, y + yi + drHeight, r, g, b, 255);
              } else {
                setPixel(x, y + yi + li * 2, r, g, b, 255);
              }
          }
          drHeight += parseInt(inVal[1].value);
          } else if(inVal.length == 3) {
            RandHeight = getRandomInt(parseInt(inVal[1].value), parseInt(inVal[2].value));
            //console.log(RandHeight);
            for(y = 0; y < RandHeight ; y++) {
              if(li <= document.getElementById('layerStop').value) {
                setPixel(x, y + yi + drHeight, r, g, b, 255);
              } else {
                setPixel(x, y + yi + li * 2, r, g, b, 255);
              }


            }
          drHeight += RandHeight;
        }

        
      }

    }

    return

}

function getRandomInt(min, max) {
  return Math.round(Math.random() * (max - min)) + min;
}

function createGrid(x, y) {
  tbl = document.getElementById('imgTable');
  tbl.innerHTML = '';

  for (let i = 0; i < y; i++) {
    const tr = tbl.insertRow();
    for (let j = 0; j < x; j++) {
        tr.insertCell();
    }
  }
}

function getPixel(x, y) {
  cell = document.getElementById("imgTable").rows[y].cells[x].style.backgroundColor;

  var c = cell.replace(/^rgba?\(|\s+|\)$/g,'').split(',');
  if(c.length == 3) {c.push('255');}

  return c
}

function setPixel(x, y, r, g, b, a) {
  x--;y--;
  if(x+1 > Math.round(document.getElementById('width').value) || y+1 > Math.round(document.getElementById('height').value) || x < 0 || y < 0){}else{
    document.getElementById("imgTable").rows[y].cells[x].style.backgroundColor = "rgba(" + r + "," + g + "," + b + "," + 1 + ")";
  }
}

</script>


<script src="page.js"></script>
</html>
